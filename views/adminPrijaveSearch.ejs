<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    <link rel='stylesheet' href='/stylesheets/style.css' />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">

</head>
<body style="background-color: #f4f5f7;">
<%- include('components/adminNav') %>


<section class="pt-4 padding-kartice">
    <h3 class="text-center">Sve prijave</h3>

    <hr>
    <div class="d-flex justify-content-center text-center mb-3">
        <button id="filterToggle" class="btn btn-outline-primary d-flex align-items-center" data-bs-toggle="modal" data-bs-target="#filterModal">
            <i class="fa-solid fa-filter"></i>
            <span class="ms-2 mt-2">Filtriraj</span>
        </button>
    </div>
    <div id="messageContainer"></div>


    <div class="row gx-lg-5 mt-5">
        <div class="modal fade" id="filterModal" tabindex="-1" aria-labelledby="filterModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="filterModalLabel">Filtriraj prijave</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form id="filterForm" method="GET" action="/admin/prijave-search">
                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <label for="naziv_konkursa" class="form-label">Naziv konkursa:</label>
                                    <input type="text" name="naziv_konkursa" id="naziv_konkursa" class="form-control">
                                </div>

                                <div class="col-md-4 mb-3">
                                    <label for="naziv_firme" class="form-label">Naziv firme:</label>
                                    <input type="text" name="naziv_firme" id="naziv_firme" class="form-control">
                                </div>

                                <div class="col-md-4 mb-3">
                                    <label for="pozicija" class="form-label">Pozicija:</label>
                                    <input type="text" name="pozicija" id="pozicija" class="form-control">
                                </div>

                                <div class="col-md-4 mb-3">
                                    <label for="bodovi" class="form-label">Minimalni bodovi:</label>
                                    <input type="number" name="bodovi" id="bodovi" class="form-control">
                                </div>


                                <div class="col-md-4 mb-3">
                                    <label for="status" class="form-label">Status prijave:</label>
                                    <select name="status" id="status" class="form-select">
                                        <option value="">Svi</option>
                                        <option value="aktivno">Aktivno</option>
                                        <option value="uži krug">Uži krug</option>

                                        <option value="odbijeno">Odbijeno</option>
                                    </select>
                                </div>

                                <div class="col-md-4 mb-3">
                                    <label for="firma" class="form-label">Ime firme:</label>
                                    <input type="text" name="firma" id="firma" class="form-control">
                                </div>

                                <div class="col-md-4 mb-3">
                                    <label for="sort" class="form-label">Rangiraj:</label>
                                    <select name="sort" id="sort" class="form-select">
                                        <option value="">Bez rangiranja</option>
                                        <option value="bodovi_asc">Bodovi (rastuće)</option>
                                        <option value="bodovi_desc">Bodovi (opadajuće)</option>
                                    </select>
                                </div>

                                <div class="col-12">
                                    <button type="submit" class="btn btn-primary">Filtriraj</button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>


     <div class="table-responsive">
                <table class="table table-bordered">
                    <thead>
                    <tr>
                        <th>Naziv konkursa</th>
                        <th>Naziv firme</th>
                        <th>Pozicija</th>
                        <th>Ime</th>
                        <th>Prezime</th>
                        <th>Iskustvo</th>
                        <th>Bodovi</th>
                        <th>CV</th>
                        <th>Motivacijsko Pismo</th>
                        <th>Certifikat</th>
                        <th>Intervju</th>
                        <th>Status</th>
                    </tr>
                    </thead>
                    <tbody>
                    <% if (prijave && prijave.length > 0) { %>
                        <% prijave.forEach(prijava => { %>
                            <tr>
                                <td><%= prijava.naziv_konkursa || 'Nema' %></td>
                                <td><%= prijava.naziv_firme || 'Nema' %></td>
                                <td><%= prijava.pozicija || 'Nema' %></td>
                                <td><%= prijava.ime || 'Nema' %></td>
                                <td><%= prijava.prezime || 'Nema' %></td>
                                <td><%= prijava.iskustvo || 'Nema' %></td>
                                <td><%= prijava.bodovi !== undefined ? prijava.bodovi : 'Nema' %></td>
                                <td>
                                    <% if (prijava.cv) { %>
                                        <a href="/admin/download/cv/<%= prijava.id %>">Preuzmi</a>
                                    <% } else { %>
                                        Nema
                                    <% } %>
                                </td>
                                <td>
                                    <% if (prijava.motivacijsko_pismo) { %>
                                        <a href="/admin/download/motivacijsko/<%= prijava.id %>">Preuzmi</a>
                                    <% } else { %>
                                        Nema
                                    <% } %>
                                </td>
                                <td>
                                    <% if (prijava.certifikat) { %>
                                        <a href="/admin/download/certifikat/<%= prijava.id %>">Preuzmi</a>
                                    <% } else { %>
                                        Nema
                                    <% } %>
                                </td>
                                <td>
                                    <a href="#" class="pozovi-na-intervju" data-korisnik-id="<%= prijava.korisnik_id %>">Pozovi na intervju</a>
                                </td>

                                <div id="popup" class="popup">
                                    <div class="popup-content">
                                        <h3>Unesite datum intervjua</h3>
                                        <label for="interviewDate">Datum intervjua:</label>
                                        <input type="date" id="interviewDate" required>
                                        <button id="submitDate">Pošaljite poziv</button>
                                        <button id="closePopup">Zatvori</button>
                                    </div>
                                </div>
                                <td>
                                    <select
                                            name="status"
                                            class="form-control"
                                            data-id="<%= prijava.id %>"
                                            onchange="updateStatus(this)">
                                        <option value="aktivno" <%= prijava.status === 'aktivno' ? 'selected' : '' %>>Aktivna</option>
                                        <option value="uži krug" <%= prijava.status === 'uži krug' ? 'selected' : '' %>>Uži krug</option>
                                        <option value="odbijeno" <%= prijava.status === 'odbijeno' ? 'selected' : '' %>>Odbijena</option>
                                    </select>
                                </td>
                            </tr>
                        <% }) %>
                    <% } else { %>
                        <tr>
                            <td colspan="13" class="text-center">Nema dostupnih prijava.</td>
                        </tr>
                    <% } %>
                    </tbody>
                </table>
        </div>
    </div>

</section>
<!--Futer-->
<%- include('components/footer') %>
<script>
    function updateStatus(selectElement) {
        const prijavaId = selectElement.getAttribute('data-id');
        const status = selectElement.value;

        fetch(`/admin/update-status/${prijavaId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ status: status }),
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Greška prilikom ažuriranja statusa');
                }
                return response.json();
            })
            .then(data => {
                alert('Status uspješno ažuriran');
            })
            .catch(error => {
                console.error('Došlo je do greške:', error);
                alert('Došlo je do greške prilikom ažuriranja statusa');
            });
    }

    document.querySelectorAll('.pozovi-na-intervju').forEach(link => {
        link.addEventListener('click', (e) => {
            e.preventDefault();

            const korisnikId = e.target.getAttribute('data-korisnik-id');

            document.getElementById('popup').style.display = 'flex';

            document.getElementById('submitDate').addEventListener('click', async () => {
                const interviewDate = document.getElementById('interviewDate').value;

                if (!interviewDate) {
                    alert('Molimo vas da unesete datum intervjua.');
                    return;
                }

                try {
                    const response = await fetch(`/admin/send-intervju/${korisnikId}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ interviewDate })
                    });

                    if (response.ok) {
                        const result = await response.text();
                        document.getElementById('messageContainer').innerHTML = result;

                        document.getElementById('popup').style.display = 'none';
                    } else {
                        alert('Došlo je do greške prilikom slanja podataka.');
                    }

                } catch (error) {
                    console.error('Greška:', error);
                    alert('Došlo je do greške prilikom slanja podataka.');
                }
            });

            document.getElementById('closePopup').addEventListener('click', () => {
                document.getElementById('popup').style.display = 'none';
            });
        });
    });

</script>


<script src="	https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
