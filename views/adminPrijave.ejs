<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    <link rel='stylesheet' href='/stylesheets/style.css' />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">

</head>
<body style="background-color: #f4f5f7;">
<%- include('components/adminNav') %>


<section class="pt-4 padding-kartice">
    <h3 class="text-center">Prijave za konkurs</h3>
    <hr>
    <div id="messageContainer"></div>

    <div class="row gx-lg-5 mt-5">
        <div class="table-responsive">
            <table class="table table-bordered">
                <thead>
                <tr>
                    <th>Ime</th>
                    <th>Prezime</th>
                    <th>Grad</th>
                    <th>Iskustvo</th>
                    <th>Bodovi</th>
                    <% if (prijave.length > 0 && prijave[0].cv) { %>
                        <th>CV</th>
                    <% } %>
                    <% if (prijave.length > 0 && prijave[0].motivacijsko_pismo) { %>
                        <th>Motivacijsko Pismo</th>
                    <% } %>
                    <% if (prijave.length > 0 && prijave[0].certifikat) { %>
                        <th>Certifikat</th>
                    <% } %>
                    <th>Intervju</th>
                    <th>Status</th>
                </tr>
                </thead>
                <tbody>
                <% if (prijave && prijave.length > 0) { %>
                    <% prijave.forEach(prijava => { %>
                        <tr>
                            <td><%= prijava.ime %></td>
                            <td><%= prijava.prezime %></td>
                            <td><%= prijava.grad %></td>
                            <td><%= prijava.iskustvo %></td>
                            <td><%= prijava.bodovi%></td>
                            <% if (prijava.cv) { %>
                                <td><a href="/admin/download/cv/<%= prijava.id %>">Preuzmi</a></td>
                            <% } %>
                            <% if (prijava.motivacijsko_pismo) { %>
                                <td><a href="/admin/download/motivacijsko/<%= prijava.id %>">Preuzmi</a></td>
                            <% } %>
                            <% if (prijava.certifikat) { %>
                                <td><a href="/admin/download/certifikat/<%= prijava.id %>">Preuzmi</a></td>
                            <% } %>
                            <td>
                                <a href="#" class="pozovi-na-intervju" data-korisnik-id="<%= prijava.korisnik_id %>">Pozovi na intervju</a>
                            </td>

                            <div id="popup" class="popup">
                                <div class="popup-content">
                                    <h3>Unesite datum intervjua</h3>
                                    <label for="interviewDate">Datum intervjua:</label>
                                    <input type="date" id="interviewDate" required>
                                    <button id="submitDate">Pošaljite poziv</button>
                                    <button id="closePopup">Zatvori</button>
                                </div>
                            </div>


                            <td>
                                <select name="status" class="form-control"  data-id="<%= prijava.id %>" onchange="updateStatus(this)">
                                    <option value="aktivno" <%= prijava.status === 'aktivno' ? 'selected' : '' %>>Aktivna</option>
                                    <option value="uži krug" <%= prijava.status === 'uži krug' ? 'selected' : '' %>>Uži krug</option>
                                    <option value="odbijeno" <%= prijava.status === 'odbijeno' ? 'selected' : '' %>>Odbijena</option>
                                </select>
                            </td>
                        </tr>
                    <% }) %>
                <% } else { %>
                    <tr>
                        <td colspan="5" class="text-center">Nema dostupnih prijava.</td>
                    </tr>
                <% } %>
                </tbody>
            </table>
        </div>
    </div>

</section>
<!--Futer-->
<%- include('components/footer') %>

<script>
    function updateStatus(selectElement) {
        const prijavaId = selectElement.getAttribute('data-id');
        const status = selectElement.value;

        fetch(`/admin/update-status/${prijavaId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ status: status }),
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Greška prilikom ažuriranja statusa');
                }
                return response.json();
            })
            .then(data => {
                alert('Status uspješno ažuriran');
            })
            .catch(error => {
                console.error('Došlo je do greške:', error);
                alert('Došlo je do greške prilikom ažuriranja statusa');
            });
    }


    document.querySelectorAll('.pozovi-na-intervju').forEach(link => {
        link.addEventListener('click', (e) => {
            e.preventDefault();

            const korisnikId = e.target.getAttribute('data-korisnik-id');

            document.getElementById('popup').style.display = 'flex';

            document.getElementById('submitDate').addEventListener('click', async () => {
                const interviewDate = document.getElementById('interviewDate').value;

                if (!interviewDate) {
                    alert('Molimo vas da unesete datum intervjua.');
                    return;
                }

                try {
                    const response = await fetch(`/admin/send-intervju/${korisnikId}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ interviewDate })
                    });

                    if (response.ok) {
                        const result = await response.text();
                        document.getElementById('messageContainer').innerHTML = result;

                        document.getElementById('popup').style.display = 'none';
                    } else {
                        alert('Došlo je do greške prilikom slanja podataka.');
                    }

                } catch (error) {
                    console.error('Greška:', error);
                    alert('Došlo je do greške prilikom slanja podataka.');
                }
            });

            document.getElementById('closePopup').addEventListener('click', () => {
                document.getElementById('popup').style.display = 'none';
            });
        });
    });

</script>


<script src="	https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
